<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä¸šæ™ºæ§ç»ˆç«¯ Ultimate</title>
    <style>
        :root { --bg-color: #121212; --panel-color: #1e1e24; --text-color: #e0e0e0; --accent-color: #4cc9f0; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; transition: background 0.5s; min-height: 100vh; }
        
        /* 1. æŠ¥è­¦èƒŒæ™¯ */
        body.warn { background-color: #332b00; }
        body.stop { background-color: #2a0a0a; }

        .container { background: var(--panel-color); padding: 20px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.6); margin-top: 20px; width: 90%; max-width: 550px; border: 1px solid #333; margin-bottom: 30px; }

        /* 2. è§†é¢‘èˆå° */
        .video-stage { height: 240px; margin: 15px 0; background: #000; border-radius: 15px; overflow: hidden; border: 2px solid rgba(255,255,255,0.1); position: relative; box-shadow: inset 0 0 20px #000; }
        #robot-video { width: 100%; height: 100%; object-fit: cover; mix-blend-mode: screen; filter: brightness(0.9) contrast(1.1); transition: 0.3s; }
        body.stop #robot-video { filter: brightness(0.5) sepia(1) hue-rotate(-50deg) saturate(3); }

        /* 3. æŠ¥è­¦å¤§å›¾æ ‡ */
        #alarm-overlay { position: absolute; top:0; left:0; width:100%; height:100%; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        .alarm-icon { font-size: 5rem; display: none; animation: pulse 0.8s infinite alternate; text-shadow: 0 0 20px currentColor; }
        body.warn .alarm-icon#icon-warn { display: block; color: #ffd700; }
        body.stop .alarm-icon#icon-stop { display: block; color: #ff4444; }
        @keyframes pulse { from { transform: scale(1); opacity: 0.8; } to { transform: scale(1.15); opacity: 1; } }

        /* æ•°æ®æ˜¾ç¤º */
        .data-display { text-align: center; margin-bottom: 15px; }
        #res { font-size: 2.5rem; font-weight: bold; font-family: monospace; display:block; }
        .unit { color: #888; font-size: 1rem; }

        /* 4. é˜ˆå€¼æ§åˆ¶é¢æ¿ */
        .control-panel { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 12px; margin-bottom: 15px; border: 1px solid #444; }
        .control-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .control-row label { font-size: 0.9rem; color: #ccc; }
        .control-row input { background: #222; border: 1px solid #555; color: #4cc9f0; padding: 8px; border-radius: 5px; width: 70px; text-align: center; font-size: 1rem; font-weight: bold; }
        
        .btn-update { width: 100%; background: linear-gradient(135deg, #2e7d32, #1b5e20); color: white; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3); }
        .btn-update:active { transform: scale(0.98); }

        /* 5. è¿æ¥ä¸å½•åˆ¶æŒ‰é’® */
        .btn-connect { background: linear-gradient(135deg, var(--accent-color), #3a86ff); color: #fff; border: none; padding: 12px; border-radius: 50px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 15px; font-size: 1.1rem; box-shadow: 0 5px 15px rgba(76, 201, 240, 0.3); }
        
        .record-panel { display: flex; gap: 5px; margin-bottom: 15px; }
        .btn-rec { flex: 1; padding: 8px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; color: white; opacity: 0.5; pointer-events: none; }
        .btn-rec.active { opacity: 1; pointer-events: all; }
        #btn-start { background: #4caf50; } #btn-stop { background: #f44336; display:none; } #btn-csv { background: #ff9800; }

        /* 6. æ—¥å¿—é¢æ¿ */
        .log-panel { background: #0a0a0a; border: 1px solid #333; border-radius: 10px; padding: 10px; height: 140px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 0.8rem; text-align: left; box-shadow: inset 0 0 10px #000; }
        .log-entry { margin-bottom: 3px; padding-left: 5px; border-left: 2px solid #444; }
        .log-time { color: #555; margin-right: 5px; }
        .log-type-0 { border-color: #4caf50; color: #a5d6a7; } /* æ­£å¸¸ */
        .log-type-1 { border-color: #ffd700; color: #fff59d; } /* è­¦å‘Š */
        .log-type-2 { border-color: #ff4444; color: #ff8a80; } /* åœæœº */
        .log-type-3 { border-color: #4cc9f0; color: #81d4fa; } /* ç³»ç»Ÿ */

    </style>
</head>
<body class="bg-normal">
    <div class="container">
        <h2 style="text-align:center; margin-top:0; font-weight:300;">å·¥ä¸šæ™ºæ§ç»ˆç«¯ Pro</h2>
        
        <div class="video-stage">
            <video id="robot-video" src="robot_arm.mp4" loop muted playsinline></video>
            <div id="alarm-overlay">
                <div id="icon-warn" class="alarm-icon">âš ï¸</div>
                <div id="icon-stop" class="alarm-icon">ğŸ›‘</div>
            </div>
        </div>

        <div class="data-display">
            <span id="res">0.00</span> <span class="unit">MÎ©</span>
        </div>

        <div class="control-panel">
            <div class="control-row">
                <label>âš ï¸ è­¦å‘Šé˜ˆå€¼ (ADC)</label>
                <input type="number" id="input-warn" value="300">
            </div>
            <div class="control-row">
                <label>ğŸ›‘ åœæœºé˜ˆå€¼ (ADC)</label>
                <input type="number" id="input-stop" value="800">
            </div>
            <button class="btn-update" onclick="sendThresholds()">âš™ï¸ æ›´æ–°è®¾ç½®åˆ°ç³»ç»Ÿ </button>
            <div style="text-align:center; font-size:0.7rem; color:#666; margin-top:5px;">å½“å‰ç”Ÿæ•ˆå€¼: <span id="current-settings">-- / --</span></div>
        </div>

        <div class="record-panel">
            <button id="btn-start" class="btn-rec" onclick="startRecord()">âº å½•åˆ¶</button>
            <button id="btn-stop" class="btn-rec" onclick="stopRecord()">â¹ åœæ­¢</button>
            <button id="btn-csv" class="btn-rec" onclick="downloadCSV()">â¬‡ï¸ å¯¼å‡ºCSV</button>
        </div>

        <button class="btn-connect" onclick="connectBLE()">ğŸ“¡ è¿æ¥è®¾å¤‡</button>

        <div class="log-panel">
            <div id="log-list"></div>
        </div>
    </div>

    <script>
        let pCharData, pCharControl;
        const robotVideo = document.getElementById('robot-video');
        let lastMode = -1;
        
        // å½•åˆ¶ç›¸å…³
        let isRecording = false;
        let recordedData = [];

        robotVideo.pause();

        async function connectBLE() {
            try {
                addLog("æ­£åœ¨æ‰«æè®¾å¤‡...", 3);
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'Industrial_Robot_Monitor' }],
                    optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
                });
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
                
                // 1. è·å–æ•°æ®é€šé“
                pCharData = await service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');
                pCharData.startNotifications();
                pCharData.addEventListener('characteristicvaluechanged', handleData);
                
                // 2. è·å–æ§åˆ¶é€šé“ (è¿™æ­¥å¾ˆå…³é”®ï¼Œæ²¡æœ‰å®ƒæ§åˆ¶åŠŸèƒ½å°±åºŸäº†)
                pCharControl = await service.getCharacteristic('1c95d5e3-d8bc-4e31-9988-16c5b5f90a8f');

                addLog("âœ… è¿æ¥æˆåŠŸï¼Œé€šé“å»ºç«‹", 3);
                document.getElementById('btn-start').classList.add('active'); // æ¿€æ´»å½•åˆ¶
                robotVideo.play().catch(e=>console.log("ç­‰å¾…äº¤äº’"));
                
            } catch (err) { 
                addLog("âŒ è¿æ¥å¤±è´¥: " + err.message, 2);
                alert("è¿æ¥å¤±è´¥: " + err); 
            }
        }

        function handleData(e) {
            const raw = new TextDecoder().decode(e.target.value);
            // è§£æ: "ç”µé˜»,æ¨¡å¼,å½“å‰è­¦å‘Šçº¿,å½“å‰åœæœºçº¿"
            const [res, modeStr, curWarn, curStop] = raw.split(',');
            const mode = parseInt(modeStr);
            const resVal = parseFloat(res).toFixed(2);
            
            // æ›´æ–° UI
            document.getElementById('res').innerText = resVal;
            if(curWarn && curStop) {
                document.getElementById('current-settings').innerText = `${curWarn} / ${curStop}`;
            }
            
            // çŠ¶æ€æœºé€»è¾‘
            const body = document.body;
            if(mode === 2) { // åœæœº
                body.className = "stop"; 
                robotVideo.pause();
            } else if(mode === 1) { // è­¦å‘Š
                body.className = "warn"; 
                if(robotVideo.paused) robotVideo.play();
            } else { // æ­£å¸¸
                body.className = "bg-normal"; 
                if(robotVideo.paused) robotVideo.play();
            }

            // æ—¥å¿—å»é‡é€»è¾‘
            if (mode !== lastMode) {
                if (mode === 2) addLog(`ğŸ”´ è§¦å‘é«˜æ¸©åœæœº [R:${resVal}MÎ©]`, 2);
                else if (mode === 1) addLog(`ğŸŸ¡ æ£€æµ‹åˆ°æ¸©åº¦å¼‚å¸¸ [R:${resVal}MÎ©]`, 1);
                else if (mode === 0 && lastMode !== -1) addLog(`ğŸŸ¢ ç³»ç»Ÿæ¢å¤æ­£å¸¸ [R:${resVal}MÎ©]`, 0);
                lastMode = mode;
            }

            // æ•°æ®å½•åˆ¶
            if(isRecording) {
                const now = new Date();
                recordedData.push({
                    time: now.toLocaleTimeString() + "." + now.getMilliseconds(),
                    resistance: resVal,
                    mode: mode
                });
            }
        }

        async function sendThresholds() {
            if(!pCharControl) { alert("è¯·å…ˆè¿æ¥è“ç‰™ï¼"); return; }
            
            const warnVal = document.getElementById('input-warn').value;
            const stopVal = document.getElementById('input-stop').value;
            const cmd = `${warnVal},${stopVal}`;
            
            try {
                const encoder = new TextEncoder();
                await pCharControl.writeValue(encoder.encode(cmd));
                addLog(`âš™ï¸ æŒ‡ä»¤å·²å‘é€: ${cmd}`, 3);
            } catch(e) {
                addLog("âŒ å‘é€å¤±è´¥: " + e, 2);
            }
        }

        // --- å½•åˆ¶ä¸æ—¥å¿—å·¥å…·å‡½æ•° ---
        function startRecord() {
            isRecording = true;
            recordedData = [];
            document.getElementById('btn-start').style.display='none';
            document.getElementById('btn-stop').style.display='block';
            document.getElementById('btn-csv').classList.remove('active');
            addLog("âº å¼€å§‹å½•åˆ¶æ•°æ®...", 3);
        }
        function stopRecord() {
            isRecording = false;
            document.getElementById('btn-start').style.display='block';
            document.getElementById('btn-stop').style.display='none';
            document.getElementById('btn-csv').classList.add('active');
            addLog(`â¹ å½•åˆ¶ç»“æŸï¼Œå…± ${recordedData.length} æ¡`, 3);
        }
        function downloadCSV() {
            if(recordedData.length === 0) return;
            let csv = "Time,Resistance(MÎ©),Mode\n";
            recordedData.forEach(row => { csv += `${row.time},${row.resistance},${row.mode}\n`; });
            const link = document.createElement("a");
            link.href = 'data:text/csv;charset=utf-8,\uFEFF' + encodeURI(csv);
            link.download = `Robot_Data_${Date.now()}.csv`;
            link.click();
        }

        function addLog(msg, type) {
            const list = document.getElementById('log-list'); // ä¿®å¤æ—¥å¿—åˆ—è¡¨ID
            if(!list) return; 
            
            // è‡ªåŠ¨åˆ›å»ºåˆ—è¡¨å®¹å™¨ï¼ˆå¦‚æœä¹‹å‰çš„ä»£ç é‡Œä¸å°å¿ƒåˆ äº†ï¼‰
            if(list.parentNode.className !== 'log-panel') {
               // è¿™é‡Œæ˜¯åŒé‡ä¿é™©
            }

            const entry = document.createElement('div');
            entry.className = `log-entry log-type-${type}`;
            const now = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            entry.innerHTML = `<span class="log-time">[${now}]</span>${msg}`;
            
            // æ’å…¥å¹¶æ»šåŠ¨
            const panel = document.querySelector('.log-panel');
            panel.insertBefore(entry, panel.firstChild); // æ–°æ—¥å¿—åœ¨æœ€ä¸Šé¢
            if(panel.children.length > 50) panel.removeChild(panel.lastChild);
        }
    </script>
</body>
</html>

